.PHONY: help
help: ## Show this help message
	@grep -E '^[a-zA-Z_-]+:.*?## .*$$' $(MAKEFILE_LIST) | sort | awk 'BEGIN {FS = ":.*?## "}; {printf "\033[36m%-15s\033[0m %s\n", $$1, $$2}'

.DEFAULT_GOAL := help

.PHONY: test
test: ## Run net.async test (non-dockerized)
	clojure -M:netasync test netasync --time-limit $${TIME:-10} --nodes n1,n2,n3,n4,n5

.PHONY: test-docker
test-docker: ## Run dockerized net.async test with network partition nemesis
	clojure -M:netasync-docker test --time-limit $${TIME:-60} --nodes n1,n2,n3,n4,n5

.PHONY: test-docker-minimal
test-docker-minimal: ## Run minimal dockerized test without nemesis
	clojure -M:netasync-docker test --minimal --time-limit $${TIME:-30} --nodes n1,n2,n3,n4,n5

.PHONY: performance
performance: ## Run performance stress test
	clojure -M:performance escalating

.PHONY: start-nodes
start-nodes: ## Start net.async Raft nodes (n1, n2, n3, n4, n5)
	@echo "🚀 Starting net.async Raft nodes..."
	@mkdir -p logs
	@clojure -M -m jepsen-raft.raft-node n1 9001 7001 n1,n2,n3,n4,n5 > logs/n1.log 2>&1 & echo "Started n1 (PID: $$!)"
	@clojure -M -m jepsen-raft.raft-node n2 9002 7002 n1,n2,n3,n4,n5 > logs/n2.log 2>&1 & echo "Started n2 (PID: $$!)"
	@clojure -M -m jepsen-raft.raft-node n3 9003 7003 n1,n2,n3,n4,n5 > logs/n3.log 2>&1 & echo "Started n3 (PID: $$!)"
	@clojure -M -m jepsen-raft.raft-node n4 9004 7004 n1,n2,n3,n4,n5 > logs/n4.log 2>&1 & echo "Started n4 (PID: $$!)"
	@clojure -M -m jepsen-raft.raft-node n5 9005 7005 n1,n2,n3,n4,n5 > logs/n5.log 2>&1 & echo "Started n5 (PID: $$!)"
	@echo "⏳ Waiting for nodes to start..."
	@sleep 5
	@echo "🔍 Checking node health..."
	@make --silent check-nodes

.PHONY: stop-nodes
stop-nodes: ## Stop all net.async Raft nodes
	@echo "🛑 Stopping net.async Raft nodes..."
	@pkill -f "jepsen-raft.raft-node" || echo "No nodes were running"
	@echo "✅ All nodes stopped"

.PHONY: check-nodes
check-nodes: ## Check if net.async nodes are running and healthy
	@echo "📊 Node Status:"
	@for port in 7001 7002 7003 7004 7005; do \
		node=n$$(($$port - 7000)); \
		if curl -s --connect-timeout 2 http://localhost:$$port/health >/dev/null 2>&1; then \
			health=$$(curl -s http://localhost:$$port/health); \
			echo "  ✅ $$node (port $$port): $$health"; \
		else \
			echo "  ❌ $$node (port $$port): Not responding"; \
		fi; \
	done

.PHONY: restart-nodes
restart-nodes: ## Restart all net.async nodes with fresh state
	@echo "🔄 Restarting net.async nodes with fresh state..."
	@make --silent stop-nodes
	@sleep 2
	@rm -rf /tmp/jepsen-raft-network/
	@make --silent start-nodes

.PHONY: docker-build
docker-build: ## Build Docker images for net.async testing
	cd docker && docker-compose build

.PHONY: docker-up
docker-up: ## Start net.async Docker test environment
	cd docker && docker-compose up -d

.PHONY: docker-down
docker-down: ## Stop and remove net.async Docker test environment
	cd docker && docker-compose down -v

.PHONY: docker-logs
docker-logs: ## Show logs from net.async Docker containers
	cd docker && docker-compose logs -f

.PHONY: docker-test-network
docker-test-network: ## Test network partition scenarios
	cd docker && ./test-network-partition.sh test-scenario


.PHONY: lint
lint: ## Lint source code with clj-kondo
	clojure -M:lint

.PHONY: clean
clean: ## Remove all test results and temporary files
	rm -rf store/
	rm -rf /tmp/jepsen-raft-network/
	pkill -f "jepsen-raft.raft-node" || true
	docker-compose -f docker/docker-compose.yml down -v 2>/dev/null || true